apiVersion: v1
kind: Service
metadata:
  name: peer0
spec:
  type: NodePort
  selector:
    app: peer0
  ports:
  - name: app
    protocol: TCP
    port: 7051
    targetPort: 7051
    nodePort: 30200
  - name: operations
    protocol: TCP
    port: 9443
    targetPort: 9443
    nodePort: 30201

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: peer0
  labels:
    app: peer0
spec:
  replicas: 1
  selector:
    matchLabels:
      app: peer0
  template:
    metadata:
      labels:
        app: peer0
    spec:

      volumes:
      - name: hlf-artifacts
        persistentVolumeClaim:
          claimName: hlf-artifacts-pvc
      - name: core-yaml
        configMap:
          name: core-yaml
          items:
          - key: "core.yaml"
            path: "core.yaml"
      - name: docker-socket
        hostPath:
          path: /var/run/docker.sock

      initContainers:
      - name: alpine
        image: alpine:3
        command: ['sh', '-c', 'sleep 30']

      containers:
      - name: couchdb
        image: couchdb:3.1.1
        env:
        - name: COUCHDB_USER
          value: user
        - name: COUCHDB_PASSWORD
          value: pass
        ports:
        - name: db
          containerPort: 5984

      - name: peer
        image: hyperledger/fabric-peer:2.3.0
        workingDir: /opt/gopath/src/github.com/hyperledger/fabric
        command: ["peer"]
        args: ["node", "start"]
        ports:
        - name: app
          containerPort: 7051
        - name: operations
          containerPort: 9443
        env:
        - name: TZ
          value: "America/Bogota"
        - name: CORE_PEER_ID
          value: "peer0"
        - name: CORE_NETWORKID
          value: "dev"
        - name: CORE_PEER_GOSSIP_BOOTSTRAP
          value: "peer0:7051"
        - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT
          value: "peer0:7051"
        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME
          value: "user"
        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD
          value: "pass"
        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS
          value: "localhost:5984"
        - name: CORE_PEER_TLS_CLIENTROOTCAS_FILES
          value: "msp/tlscacerts/tlsca.ExampleOrg-cert.pem"

        volumeMounts:
        - name: hlf-artifacts
          mountPath: "/etc/hyperledger/fabric"
          subPath: "certs/peerOrganizations/ExampleOrg/peers/peer0"
        - name: core-yaml
          mountPath: "/etc/hyperledger/fabric/core.yaml"
          subPath: "core.yaml"
        - name: docker-socket
          mountPath: /var/run/docker.sock